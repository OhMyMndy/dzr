<!--VSCode require at least 1 (one) user interaction for Audio playback: use this popup -->
<dialog open style="border:none;border-radius:25px;box-shadow: 0 0 0 2000px rgb(20 20 20 / 95%);z-index: 9;">
    <form method="dialog">
        <h1>Disclamer</h1>
        <ul>
            <li>Use the <b>Player Queue side-panel</b> to add/remove track</li>
            <li>Closing <b>this player tab</b> will stop the playback</li>
        </ul>
        <div><button style="width: 100%;">OK</button></div>
    </form>
</dialog>
<img style="display: block;margin: auto; width: 50vmin; height: 50vmin; padding-top: 10vmin;">
<audio controls onloadstart="play()" style="display: block;margin: auto;width: 50vmin; height: 25vmin;"></audio>
<script type=module>
const post = acquireVsCodeApi().postMessage;
const [img] = document.getElementsByTagName('img');
const [audio] = document.getElementsByTagName('audio');
const [dialog] = document.getElementsByTagName('dialog');
const cmd = (name, ...args) => `command:${name}?` + encodeURIComponent(JSON.stringify(args));
dialog.onclose=()=>{audio.play();post('user_interact');}
['ended', 'pause', 'playing'].map(on => audio.addEventListener(on, () => post('player_' + on)));
let mediaSource, sourceBuffer;
const on = {// event from VSCode
    async open(item) {
        img.src = `https://e-cdns-images.dzcdn.net/images/cover/${item.md5_image}/1000x1000-000000-80-0-0.jpg`;
        mediaSource = new window.MediaSource();
        audio.src = window.URL.createObjectURL(mediaSource);
        await new Promise(then => mediaSource.onsourceopen = () => then());
        sourceBuffer = mediaSource.addSourceBuffer("audio/mpeg");
        sourceBuffer.addEventListener("updateend", (ev) => post('player_bufferized'));
    },
    append(buf) { sourceBuffer.appendBuffer(buf) },
    close() { mediaSource.endOfStream() },
    play() { audio.play().catch(e=>post('error', e)) },
    pause() { audio.pause() },
    state(state, updates=[]) { }
};
window.addEventListener('message', ({ data: [cmd,...args] }) => {
    if (!on[cmd]) return console.log("bad message:" + JSON.stringify([cmd,...args]));
    on[cmd](...args);
});

</script>
<style>dialog::backdrop {background-color: rgba(0,0,0,.9);}</style>